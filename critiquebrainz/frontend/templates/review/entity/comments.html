{% if comments %}
  <hr/>
  <h3> Comments ({{ comment_count }})</h3>
  <div id="comment-list">
    {% for comment in comments %}
      <hr/>
      <div id="{{ comment.id }}" class="comment-container">
        <div class="comment-header">
          {{ comment_credit(comment, user_picture_size=24) }}
          {% if current_user.is_authenticated and current_user == comment.user %}
            <a href="{{ url_for('comment.delete', id=comment.id) }}"
               class="btn btn-danger btn-xs"
               title="{{ _('Delete this comment') }}">
                <span class="glyphicon glyphicon-trash"></span>
            </a>
            <button class="comment-edit-button btn btn-primary btn-xs"
                    title="{{ _('Edit this comment') }}">
              <span class="glyphicon glyphicon-edit"></span>  
            </button>
          {% endif %}
          <span style="float:right;">
            <small><em class="text-muted"> {{comment.created | date}} </em></small>
          </span>
        </div>
        <div class="comment-content">
          <div class="comment-content-html">
            {{ comment.text_html|safe }}
          </div>
          <p class="comment-content-mark" style="display: none;">{{ comment.last_revision.text }}</p>
        </div>
        <div class="comment-edit-form" style="display: none;">
          <form method="POST" class="form-horizontal" role="form" action="{{ url_for('comment.edit', id=comment.id) }}">
            <div class="form-group">
              {{ comment_form.hidden_tag() }}
              {{ comment_form.text(class="comment-text") }}
            </div>
            <div class="form-group">
              <button type="submit" class="btn btn-primary">{{ _('Update comment') }}</button>
            </div>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% if current_user.is_authenticated %}
  <hr/>
  <div id="comment-add-form">
    <form method="POST" class="form-horizontal" role="form" action="{{ url_for('comment.create') }}">
      <div class="form-group">
        {{ comment_form.hidden_tag() }}
        {{ comment_form.text(class="comment-text") }}
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">{{ _('Add comment') }}</button>
      </div>
    </form>
  </div>
{% endif %}


{% block scripts %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css"/>
  <script src="{{ get_static_path('wysiwyg-editor.js') }}"></script>
  <script>
    $(document).ready(function() {
      simplemde = {};
      simplemde["commentAddForm"] = new SimpleMDE({
        element: $("#comment-add-form").find(".comment-text")[0],
        spellChecker: false
      });

      $(".comment-edit-button").click(function() {

        let commentDiv = $(this).closest(".comment-container"),
            commentEditForm = commentDiv.find(".comment-edit-form"),
            commentText = commentEditForm.find(".comment-text")[0],
            commentContentDiv = commentDiv.find(".comment-content"),
            commentContentText = commentContentDiv.find(".comment-content-mark").text(),
            commentDivId = commentDiv.attr("id");
        commentEditForm.toggle();
        commentContentDiv.toggle();
        if (!simplemde[commentDivId]) {
          simplemde[commentDivId] = new SimpleMDE({
            element: commentText,
            spellChecker: false
          });
        }
        simplemde[commentDivId].value(commentContentText);
      });
    });
  </script>
{% endblock %}