{% extends 'base.html' %}

{% block title %}
Release group "{{ release_group.title }}" by {{ release_group['artist-credit'][0].artist.name }} - CritiqueBrainz
{% endblock %}

{% block content %}
<div class="clearfix">
  <h2 class="pull-left">
    {{ release_group.title }} -
    <a href="{{ url_for('artist.entity', id=release_group['artist-credit'][0].artist.id) }}">
      {{ release_group['artist-credit'][0].artist.name }}
    </a>
  </h2>
  {% if not my_review %}
    <a id="write-review" href="{{ url_for('profile_review.create', release_group=id) }}"
       role="button" class="btn btn-success pull-right">
      <span class="glyphicon glyphicon-asterisk"></span> Write a review
    </a>
  {% else %}
    <a id="edit-review" href="{{ url_for('profile_review.edit', id=my_review.id) }}"
       role="button" class="btn btn-primary pull-right">
      <span class="glyphicon glyphicon-edit"></span> Edit my review
    </a>
  {% endif %}
</div>
<div id="release-group-details" class="row">
  <div class="col-md-3">
    <img id="cover-art" class="img-responsive">
    <script>
      $("img").last()
          .on("error", function () { $(this).attr("src", "/static/img/missing-art.png"); })
          .attr("src", "//coverartarchive.org/release-group/{{ id }}/front-250");
    </script>
    <div id="spotify-play-button">
      {% if id in spotify_mapping %}
        <iframe src="https://embed.spotify.com/?uri={{ spotify_mapping[id] }}&theme=white"
                width="100%" height="80" frameborder="0" allowtransparency="true"></iframe>
      {% else %}
        <span class="text-muted"><em>We donâ€™t have a Spotify mapping for this release, please help us find the right album on Spotify.</em></span>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <h4>Reviews</h4>
    {% if not reviews %}
      <p class="lead" style="text-align: center;">No reviews found</p>
    {% else %}
      <table class="table table-condensed table-hover">
        <thead>
          <tr>
            <th>Author</th>
            <th>Published on</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody>
          {% for review in reviews %}
            <tr class="clickable-row" data-url="{{ url_for('review.entity', id=review.id) }}" data-review-id="{{ review.id }}">
              <td><img class="avatar" src="{{ review.user.avatar }}&s=18" /> {{ review.user.display_name }}</td>
              <td>{{ review.user.created }}</td>
              <td>{{ review.rating }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <ul class="pagination">
        {% set pages = count//limit %}
        {% if count%limit %}
          {% set pages = pages+1 %}
        {% endif %}
        {% if pages>1 %}
          {% for p in range(pages) %}
            {% set p_offset = p*limit %}
            <li {% if offset == p_offset %}class="active"{% endif %}>
              <a href="{{ url_for('release_group.entity', id=id, limit=limit, offset=p*limit) }}">{{ p+1 }}</a>
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    {% endif %}

    {% if release and release['medium-list'] %}
      <div id="tracklist" class="row">
        <div class="col-md-12"><h4>Tracklist</h4></div>
        {% for medium in release['medium-list'] %}
          <div class="medium col-md-6">
            {% if release['medium-count'] > 1 %}<h5><b>CD {{ medium.position }}</b></h5>{% endif %}
            {% for track in medium['track-list'] %}
              <div class="track">{{ track.number }}. {{ track.recording.title }}</div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="col-md-3">
    <h4>Release group information</h4>
    <p>
      {% if release_group['first-release-date'] %}First release in {{ release_group['first-release-date'][:4] }}{% endif %}
    </p>
    {% if release_group['external-urls'] %}
      <b>External links</b>
      <ul class="list-unstyled external-links">
        {% for url in release_group['external-urls'] %}
          <li class="clearfix">
            <div class="favicon-container pull-left">
              {% if url.icon %}
              <img src="{{ url_for('static', filename='favicons/'+url.icon) }}" />
              {% else %}
              <img src="{{ url_for('static', filename='favicons/external-16.png') }}" />
              {% endif %}
            </div>
            <a href="{{ url.target }}">{{ url.name }}</a>
            {% if url.disambiguation %}<span class="text-muted">({{ url.disambiguation }})</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    <p><a href="//musicbrainz.org/release-group/{{ release_group.id }}"><em>Edit on MusicBrainz</em></a></p>
  </div>
</div>
{% endblock %}
